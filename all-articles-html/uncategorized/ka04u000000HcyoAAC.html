<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Function to Extract OU Name from DN</title>
    <meta name="article-id" content="ka04u000000HcyoAAC">
    <meta name="articlecaseattachcount" content="0">
    <meta name="articlecreatedbyid" content="0054u000006god6AAA">
    <meta name="articlecreateddate" content="2022-02-01T18:43:11.000Z">
    <meta name="articlenumber" content="000007345">
    <meta name="createdbyid" content="0054u000006god6AAA">
    <meta name="createddate" content="2023-05-08T10:12:39.000Z">
    <meta name="firstpublisheddate" content="2022-02-01T18:43:12.000Z">
    <meta name="islatestversion" content="true">
    <meta name="knowledgearticleid" content="kA04u0000000IwLCAU">
    <meta name="knowledge-article-id" content="kA04u0000000IwLCAU">
    <meta name="lastmodifiedbyid" content="0054u000006gSmgAAE">
    <meta name="lastmodifieddate" content="2023-05-08T10:12:40.000Z">
    <meta name="lastpublisheddate" content="2022-02-01T18:43:12.000Z">
    <meta name="meta-description" content="360008408371">
    <meta name="meta-title" content="SQL Function to Extract OU Name from DN">
    <meta name="ownerid" content="0054u000006god6AAA">
    <meta name="recordtypeid" content="0124u000000UUgLAAW">
    <meta name="urlname" content="7345">
    <meta name="versionnumber" content="1">
    <meta name="website-url" content="&lt;a href=&quot;https://helpcenter.netwrix.com/bundle/z-kb-articles-salesforce/page/kA04u0000000IwLCAU.html&quot; target=&quot;_blank&quot;&gt;Open in a new window&lt;/a&gt;">
</head>
<body>
    <h1>SQL Function to Extract OU Name from DN</h1>
    <p><strong><span class="wysiwyg-font-size-large">Summary:</span></strong> Description and code to create a reusable function in SQL to easily extract Organizational Unit Name from the DistinguishedName</p>
<p><strong><span class="wysiwyg-font-size-large">Issue:</span></strong> <span style="font-size: 11pt;">Quite often we have the need for reporting purposes to identify the Organization Unit from the Users DistinguishedName. This is currently not available in the OOB reports.</span></p>
<p><strong><span class="wysiwyg-font-size-large">Instructions:</span></strong> <span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><strong>:</strong>� By creating the below function we are easily able to extract OU from DN in a simple process of passing the DN value as a parameter for the SQL Function to process, simplifying your SQL code.</span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;">The code utilizes several inbuilt sql functions which are listed out below.� </span></span></p>
<p>�</p>
<p><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;">1. PatIndex</span></span></p>
<p>2. <span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;">Charindex</span></span></p>
<p>3. <span style="font-family: Calibri, sans-serif;font-size: 11pt;">Substring</span></p>
<p><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;">�</span></span><br><strong><span class="wysiwyg-underline"><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;">Setup a SteathAUDIT Job with Analysis</span></span></span></strong></p>
<p><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;">Create a new analysis using the SQLScripting analysis module. </span></span></p>
<p><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;">Name this Analysis something that is easily identifiable for example &quot;SQL Function creation&quot;.�</span></span></p>
<p><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"> Give it a description including the name of the function being created; in this instance it should be </span></span></p>
<p><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 10pt;">[</span></span></span><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 10pt;">dbo].[SA_ENG_GetOUFromDN]</span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;">�</span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span class="wysiwyg-underline"><strong>Create SQL script</strong></span>� </span></span></p>
<p><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;">Click configure and add the below code. </span></span></p>
<p><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;">Save and Exit</span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;">�</span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;">Script:</span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 10pt;">IF EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N&#39;[dbo].[SA_ENG_GetOUFromDN]&#39;) AND type in (N&#39;FN&#39;))</span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 10pt;">DROP FUNCTION [dbo].[SA_ENG_GetOUFromDN]</span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 10pt;">�</span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 10pt;">GO</span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 10pt;">;</span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 10pt;">CREATE FUNCTION dbo.SA_ENG_GetOUFromDN (@DN nvarchar(450))</span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 10pt;">� RETURNS nvarchar(450)</span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 10pt;">AS</span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 10pt;">BEGIN</span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 10pt;">� DECLARE @IDX INT</span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 10pt;">� DECLARE @RetVal NVARCHAR(450)</span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 10pt;">�</span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 10pt;">� SET @IDX = PATINDEX(&#39;%OU=%&#39;, @DN)</span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 10pt;">��� SET @RetVal = CAST(@IDX AS nvarchar(450))</span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 10pt;">� IF @IDX = 0</span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 10pt;">� BEGIN</span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 10pt;">��� SET @RetVal = NULL</span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 10pt;">� END</span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 10pt;">� ELSE</span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 10pt;">� BEGIN</span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 10pt;">��� SET @RetVal = SUBSTRING(@DN, @IDX+ 3, CHARINDEX(&#39;,&#39;, SUBSTRING(@DN, @IDX, LEN(@DN))) -4) </span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 10pt;">��END</span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 10pt;">�</span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 10pt;">� RETURN @RetVAL</span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 10pt;">END</span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 10pt;">�</span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 10pt;">GO</span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;">�</span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;">Step three: Run the SQL analysis to create the function.</span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;">�</span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;">How to Use the function:� Below is a simple query which will return the users OU as a column from the SA_ADInventory_UsersView</span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;">�</span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;">Example: </span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;">�</span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 9.5pt;"><span style="font-family: Consolas;"><span style="color: blue;">select</span></span></span><span style="font-size: 9.5pt;"><span style="font-family: Consolas;"> SamAccountName</span></span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 9.5pt;"><span style="font-family: Consolas;"><span style="color: gray;">,</span></span></span><span style="font-size: 9.5pt;"><span style="font-family: Consolas;"> NTAccount</span></span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 9.5pt;"><span style="font-family: Consolas;"><span style="color: gray;">,</span></span></span><span style="font-size: 9.5pt;"><span style="font-family: Consolas;"> [dbo]<span style="color: gray;">.</span>[SA_ENG_GetOUFromDN]<span style="color: gray;">(</span>DistinguishedName<span style="color: gray;">)</span> <span style="color: blue;">as</span> OU</span></span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 9.5pt;"><span style="font-family: Consolas;"><span style="color: gray;">,</span></span></span><span style="font-size: 9.5pt;"><span style="font-family: Consolas;"> DistinguishedName</span></span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 9.5pt;"><span style="font-family: Consolas;">�</span></span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;"><span style="font-size: 9.5pt;"><span style="font-family: Consolas;"><span style="color: blue;">From</span></span></span><span style="font-size: 9.5pt;"><span style="font-family: Consolas;"> SA_ADInventory_usersView</span></span></span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;">�</span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;">Output:</span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;">�</span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;">SamAccountName��������� NTAccount�������� ����������������������������� OU�������� �������������� �������������� DistinguishedName</span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;">ADM_Admin����� �������������� DOMAIN\ADM_Admin�� �������������� PrivilegedUsers �������������� CN=ADM_ Admin,OU=PrivilegedUsers,OU=Australia,DC=DOMAIN,DC=local</span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;">M136694����������� �������������� DOMAIN\M136694�������� �������������� StandardUsers�� �������������� CN=Test User 5,OU=StandardUsers,OU=Australia,DC=DOMAIN,DC=local</span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;">M136695����������� �������������� DOMAIN\M136695�������� �������������� StandardUsers�� �������������� CN=Test User 6,OU=StandardUsers,OU=Australia,DC=DOMAIN,DC=local</span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;">�</span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;">Explanation on example:</span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;">Note that the function is included in the select Statement followed by an Alias of &quot;OU&quot; this is so when the job is run and inserted into table it will have a column header which is a requirement for select INTO.</span></span><br><span style="font-size: 11pt;"><span style="font-family: Calibri,sans-serif;">We pass the column name DistinguishedName from the SA_ADInventory_UsersView table to the function which pulls out the first OU=</span></span><br>�</p>
<p><strong><span class="wysiwyg-font-size-large">Product:</span></strong> StealthAUDIT<br><strong><span class="wysiwyg-font-size-large">Module:</span></strong> SA - Core<br><strong><span class="wysiwyg-font-size-large">Versions:</span></strong> 7.2+<br><strong><span class="wysiwyg-font-size-large">Legacy Article ID:</span></strong> 2422</p>
</body>
</html>