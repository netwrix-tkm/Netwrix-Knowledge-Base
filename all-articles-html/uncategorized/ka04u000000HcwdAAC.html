<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test remote process creation</title>
    <meta name="article-id" content="ka04u000000HcwdAAC">
    <meta name="articlecaseattachcount" content="0">
    <meta name="articlecreatedbyid" content="0054u000006god6AAA">
    <meta name="articlecreateddate" content="2022-02-01T18:32:49.000Z">
    <meta name="articlenumber" content="000007186">
    <meta name="createdbyid" content="0054u000006god6AAA">
    <meta name="createddate" content="2023-05-08T10:11:48.000Z">
    <meta name="firstpublisheddate" content="2022-02-01T18:32:49.000Z">
    <meta name="islatestversion" content="true">
    <meta name="knowledgearticleid" content="kA04u0000000IpeCAE">
    <meta name="knowledge-article-id" content="kA04u0000000IpeCAE">
    <meta name="lastmodifiedbyid" content="0054u000006gSmgAAE">
    <meta name="lastmodifieddate" content="2023-05-08T10:11:48.000Z">
    <meta name="lastpublisheddate" content="2022-02-01T18:32:49.000Z">
    <meta name="meta-description" content="360008408371">
    <meta name="meta-title" content="Test remote process creation">
    <meta name="ownerid" content="0054u000006god6AAA">
    <meta name="recordtypeid" content="0124u000000UUgLAAW">
    <meta name="urlname" content="7186">
    <meta name="versionnumber" content="1">
    <meta name="website-url" content="&lt;a href=&quot;https://helpcenter.netwrix.com/bundle/z-kb-articles-salesforce/page/kA04u0000000IpeCAE.html&quot; target=&quot;_blank&quot;&gt;Open in a new window&lt;/a&gt;">
</head>
<body>
    <h1>Test remote process creation</h1>
    <p><strong><span class="wysiwyg-font-size-large">Summary:</span></strong> Uses WMI to spawn a notepad.exe process on a remote machine. This can be useful for troubleshooting applet or agent deployment from StealthAUDIT, StealthINTERCEPT, or STEALTHbits Activity Monitor (SAM), since it requires the same privileges, ports, etc., but results in demonstrably negligible load to the target device.</p>
<p><strong><span class="wysiwyg-font-size-large">Issue:</span></strong> Receive Access Denied, Insufficient Privilege, Path not found, Invalid Parameter, or other error message when trying to start a process (e.g., SmartLOG applet, agent installer)</p>
<p><strong><span class="wysiwyg-font-size-large">Instructions:</span></strong> The following script emulates the behavior of the product when it attempts to launch a process remotely using WMI. It will not fix the issue, but it does help to show that an issue is related to permissions or privileges, rather than the product.<br>�<br>�<br><span style="color: darkgreen;"><span style="font-family: lucida console;"><span style="font-size: 9pt;"></span></span><br><span style="color: darkgreen;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">��� STEALTHbits Technologies, Inc.</span></span></span><br><span style="color: darkgreen;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">��� Kyle Enman</span></span></span><br><span style="color: darkgreen;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">��� 2018/10/04</span></span></span><br><span style="color: darkgreen;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">��� Uses WMI to spawn a notepad.exe process on a remote machine.</span></span></span><br><span style="color: darkgreen;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">��� Useful for troubleshooting applet or agent deployment from StealthAUDIT, StealthINTERCEPT, or STEALTHbits Activity Monitor (SAM), since it requires the same privileges, ports, etc., but results in demonstrably negligible load to the target device.</span></span></span><br><span style="color: darkgreen;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">#&gt;</span></span></span><br>�<br><span style="color: darkgreen;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">#gets credentials for testing</span></span></span><br><span style="color: darkblue;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">if</span></span></span><span style="font-family: lucida console;"><span style="font-size: 9pt;"> (<span style="color: orangered;">$cred</span> <span style="color: darkgray;">-eq</span> <span style="color: orangered;">$null</span>){<span style="color: orangered;">$cred</span> <span style="color: darkgray;">=</span> <span style="color: blue;">get-credential</span>}</span></span><br>�<br>�<br><span style="color: darkblue;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">if</span></span></span><span style="font-family: lucida console;"><span style="font-size: 9pt;">(<span style="color: orangered;">$Results</span> <span style="color: darkgray;">-ne</span> <span style="color: orangered;">$null</span>){<span style="color: blue;">Remove-Variable</span> <span style="color: blueviolet;">Results</span>}</span></span><br><span style="color: darkblue;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">if</span></span></span><span style="font-family: lucida console;"><span style="font-size: 9pt;">(<span style="color: orangered;">$TermResults</span> <span style="color: darkgray;">-ne</span> <span style="color: orangered;">$null</span>){<span style="color: blue;">Remove-Variable</span> <span style="color: blueviolet;">TermResults</span>}</span></span><br>�<br>�<br><span style="color: darkgreen;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">#input target Windows server</span></span></span><br><span style="color: orangered;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">$compName</span></span></span><span style="color: darkgray;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">=read-host </span></span></span><span style="color: darkred;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">&#39;Enter Server Name&#39;</span></span></span><br>�<br><span style="color: darkgreen;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">#instantiate process and create it on the target server</span></span></span><br><span style="color: orangered;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">$process</span></span></span><span style="font-family: lucida console;"><span style="font-size: 9pt;"> <span style="color: darkgray;">=</span> <span style="color: blue;">get-wmiobject</span> <span style="color: navy;">-query</span> <span style="color: darkred;">&quot;SELECT * FROM Meta_Class WHERE __Class = &#39;Win32_Process&#39;&quot;</span> <span style="color: navy;">-namespace</span> <span style="color: darkred;">&quot;root\cimv2&quot;</span> <span style="color: navy;">-computername</span> <span style="color: orangered;">$CompName</span> <span style="color: navy;">-credential</span> <span style="color: orangered;">$cred</span> <span style="color: navy;">-ErrorAction</span> <span style="color: blueviolet;">SilentlyContinue</span></span></span><br><span style="color: darkblue;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">if</span></span></span><span style="font-family: lucida console;"><span style="font-size: 9pt;">(<span style="color: orangered;">$process</span> <span style="color: darkgray;">-eq</span> <span style="color: orangered;">$null</span>){</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">��� <span style="color: orangered;">$Error</span><span style="color: darkgray;">[</span><span style="color: purple;">0</span><span style="color: darkgray;">].</span>Exception}</span></span><br><span style="color: darkblue;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">else</span></span></span><span style="font-family: lucida console;"><span style="font-size: 9pt;">{</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">��� <span style="color: orangered;">$results</span> <span style="color: darkgray;">=</span> <span style="color: orangered;">$process</span><span style="color: darkgray;">.</span>Create( <span style="color: darkred;">&quot;notepad.exe&quot;</span> )</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">��� <span style="color: darkblue;">If</span>(<span style="color: orangered;">$results</span><span style="color: darkgray;">.</span>ReturnValue <span style="color: darkgray;">-eq</span> <span style="color: purple;">0</span>){</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������� <span style="color: blue;">write-host</span> <span style="color: darkred;">&quot;Process Creation: Success&quot;</span>}</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">��� <span style="color: darkblue;">else</span>{</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������� <span style="color: darkred;">&quot;Process Creation: Failed - return code: </span>$(<span style="color: orangered;">$results</span><span style="color: darkgray;">.</span>ReturnValue)<span style="color: darkred;">&quot;</span>}</span></span><br>�<br><span style="font-family: lucida console;"><span style="font-size: 9pt;">��� <span style="color: darkgreen;">#output results (commented by default)</span></span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">��� <span style="color: darkgreen;">#$results</span></span></span><br>�<br>�<br><span style="font-family: lucida console;"><span style="font-size: 9pt;">��� <span style="color: darkgreen;">#Terminates process</span></span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">��� <span style="color: darkblue;">if</span>(<span style="color: orangered;">$results</span><span style="color: darkgray;">.</span>ReturnValue <span style="color: darkgray;">-eq</span> <span style="color: purple;">0</span>){</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������� <span style="color: orangered;">$TermResults</span> <span style="color: darkgray;">=</span> (<span style="color: blue;">gwmi</span> <span style="color: blueviolet;">win32_process</span> <span style="color: navy;">-ComputerName</span> <span style="color: orangered;">$CompName</span> <span style="color: navy;">-filter</span> <span style="color: darkred;">&quot;processID=</span>$(<span style="color: orangered;">$results</span><span style="color: darkgray;">.</span>ProcessID)<span style="color: darkred;">&quot;</span> <span style="color: navy;">-cred</span> <span style="color: orangered;">$cred</span>)<span style="color: darkgray;">.</span>terminate()</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������� <span style="color: darkblue;">If</span>(<span style="color: orangered;">$TermResults</span><span style="color: darkgray;">.</span>ReturnValue <span style="color: darkgray;">-eq</span> <span style="color: purple;">0</span>){<span style="color: blue;">write-host</span> <span style="color: darkred;">&quot;Process Termination: Success&quot;</span>} <span style="color: darkblue;">else</span>{<span style="color: darkred;">&quot;Process Termination: Failed - return code: </span>$(<span style="color: orangered;">$results</span><span style="color: darkgray;">.</span>ReturnValue)<span style="color: darkred;">&quot;</span>}</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">��� }</span></span><br>�<br><span style="font-family: lucida console;"><span style="font-size: 9pt;">��� <span style="color: darkgreen;">#output results (commented by default)</span></span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">��� <span style="color: darkgreen;">#$TermResults</span></span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">}</span></span><br>�<br><span style="color: darkgreen;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">https://docs.microsoft.com/en-us/windows/desktop/cimwin32prov/create-method-in-class-win32-process</span></span></span><br>�<br><span style="color: darkgreen;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">Successful completion (0)</span></span></span><br><span style="color: darkgreen;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">Access denied (2)</span></span></span><br><span style="color: darkgreen;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">Insufficient privilege (3)</span></span></span><br><span style="color: darkgreen;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">Unknown failure (8)</span></span></span><br><span style="color: darkgreen;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">Path not found (9)</span></span></span><br><span style="color: darkgreen;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">Invalid parameter (21)</span></span></span><br><span style="color: darkgreen;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">Other (22 4294967295)</span></span></span><br>�<br><span style="color: darkgreen;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">Other HRESULT errors, system error codes: <a href="https://docs.microsoft.com/en-us/windows/desktop/Debug/system-error-codes" target="_blank">https://docs.microsoft.com/en-us/windows/desktop/Debug/system-error-codes</a></span></span></span><br><span style="color: darkgreen;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">Note: Access Denied may result from bad password. RPC Server unavailable may result from a bad user ID</span></span></span><br>�<br><span style="color: darkgreen;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">#&gt;</span></span></span><br>�<br>If &quot;Success&quot; is returned, then the process was created without issue. Otherwise, review the ReturnValue (return code) of the function (which will likely match the error thrown within the product) for additional ideas on how to resolve.<br>�<br>If &quot;Success&quot; is returned, but the same results are not mirrored when using the product, then there is likely either a product issue (bug), or some other factor specific to our software (e.g., Bit9, antivirus lockdown).<br>�<br>�</span></p>
<p><strong><span class="wysiwyg-font-size-large">Product:</span></strong> StealthAUDIT<br><strong><span class="wysiwyg-font-size-large">Module:</span></strong> File Activity Monitor - Windows;SA - Core;SI - Windows Agent<br><strong><span class="wysiwyg-font-size-large">Versions:</span></strong> All<br><strong><span class="wysiwyg-font-size-large">Legacy Article ID:</span></strong> 2107</p>
</body>
</html>