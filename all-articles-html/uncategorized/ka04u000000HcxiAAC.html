<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PowerShell Data Collector: How to multi thread a query</title>
    <meta name="article-id" content="ka04u000000HcxiAAC">
    <meta name="articlecaseattachcount" content="0">
    <meta name="articlecreatedbyid" content="0054u000006god6AAA">
    <meta name="articlecreateddate" content="2022-02-01T18:38:30.000Z">
    <meta name="articlenumber" content="000007280">
    <meta name="createdbyid" content="0054u000006god6AAA">
    <meta name="createddate" content="2023-05-08T10:12:18.000Z">
    <meta name="firstpublisheddate" content="2022-02-01T18:38:31.000Z">
    <meta name="islatestversion" content="true">
    <meta name="knowledgearticleid" content="kA04u0000000It2CAE">
    <meta name="knowledge-article-id" content="kA04u0000000It2CAE">
    <meta name="lastmodifiedbyid" content="0054u000006gSmgAAE">
    <meta name="lastmodifieddate" content="2023-05-08T10:12:18.000Z">
    <meta name="lastpublisheddate" content="2022-02-01T18:38:31.000Z">
    <meta name="meta-description" content="360008408371">
    <meta name="meta-title" content="PowerShell Data Collector: How to multi thread a query">
    <meta name="ownerid" content="0054u000006god6AAA">
    <meta name="recordtypeid" content="0124u000000UUgLAAW">
    <meta name="urlname" content="7280">
    <meta name="versionnumber" content="1">
    <meta name="website-url" content="&lt;a href=&quot;https://helpcenter.netwrix.com/bundle/z-kb-articles-salesforce/page/kA04u0000000It2CAE.html&quot; target=&quot;_blank&quot;&gt;Open in a new window&lt;/a&gt;">
</head>
<body>
    <h1>PowerShell Data Collector: How to multi thread a query</h1>
    <p><strong><span class="wysiwyg-font-size-large">Summary:</span></strong> This article describes how to run multiple threads within a single PowerShell query</p>
<p><strong><span class="wysiwyg-font-size-large">Issue:</span></strong> Sample code as follows:<br><br><span style="color: darkgreen;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">#VARIABLES</span></span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������ <span style="color: orangered;">$Threadobject</span> <span style="color: darkgray;">=</span> @()� </span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������ <span style="color: orangered;">$Threadcount</span> <span style="color: darkgray;">=</span> <span style="color: purple;">10</span></span></span><br>�<br><span style="color: darkgreen;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">#CONSTANTS��� </span></span></span><br><span style="color: orangered;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">$ThreadGroup</span></span></span><span style="font-family: lucida console;"><span style="font-size: 9pt;"> <span style="color: darkgray;">=</span> <span style="color: purple;">1</span> <span style="color: darkgreen;">#Don&#39;t change </span></span></span><br>�<br><span style="font-family: lucida console;"><span style="font-size: 9pt;">��� <span style="color: darkgreen;">#divide the total threads into groups</span></span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">��� <span style="color: orangered;">$ThreadGroupCount</span> <span style="color: darkgray;">=</span> <span style="color: darkgray;">[</span><span style="color: teal;">math</span><span style="color: darkgray;">]::</span>ceiling(<span style="color: orangered;">$inputsize</span><span style="color: darkgray;">.</span>count <span style="color: darkgray;">/</span> <span style="color: orangered;">$Threadcount</span> )</span></span><br>�<br><span style="font-family: lucida console;"><span style="font-size: 9pt;">��� <span style="color: orangered;">$Counter</span> <span style="color: darkgray;">=</span> <span style="color: purple;">0</span></span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">��� <span style="color: darkblue;">foreach</span> (<span style="color: orangered;">$i</span> <span style="color: darkblue;">in</span> <span style="color: orangered;">$input</span>){</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������� <span style="color: orangered;">$counter</span><span style="color: darkgray;">++</span></span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������� <span style="color: darkgreen;">#add in any extra columns you want to pass to the thread from $i</span></span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������� <span style="color: orangered;">$result</span> <span style="color: darkgray;">=</span> <span style="color: darkred;">&quot;&quot;</span> <span style="color: darkgray;">|</span> <span style="color: blue;">Select</span> <span style="color: blueviolet;">Counter</span><span style="color: darkgray;">,</span><span style="color: blueviolet;">ThreadGroup</span></span></span><br>�<br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������� <span style="color: darkgreen;">#number the threads and count thread groups. Should all groups take the same amount of time execute this can be handy.</span></span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������� <span style="color: orangered;">$result</span><span style="color: darkgray;">.</span>Counter <span style="color: darkgray;">=</span> <span style="color: orangered;">$counter</span></span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������� <span style="color: orangered;">$result</span><span style="color: darkgray;">.</span>ThreadGroup <span style="color: darkgray;">=</span> <span style="color: orangered;">$ThreadGroup</span> <span style="color: darkgray;">-</span> <span style="color: purple;">1</span></span></span><br>�<br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������� <span style="color: darkgreen;">#POPULATE THREAD OBJECT WITH SCOPE FOR EACH THREAD</span></span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������� <span style="color: orangered;">$ThreadObject</span> <span style="color: darkgray;">+=</span> <span style="color: orangered;">$result</span></span></span><br>�<br><span style="font-family: lucida console;"><span style="font-size: 9pt;">��������<span style="color: darkblue;">If</span> ((<span style="color: orangered;">$counter</span> <span style="color: darkgray;">%</span> <span style="color: orangered;">$Threadcount</span> ) <span style="color: darkgray;">-eq</span> <span style="color: purple;">0</span>) {</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">��� �� ����<span style="color: orangered;">$ThreadGroup</span><span style="color: darkgray;">++</span></span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������� }</span></span><br>�<br><span style="font-family: lucida console;"><span style="font-size: 9pt;">}</span></span><br>�<br><span style="color: darkgreen;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">#FUNCTIONS</span></span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������ <span style="color: darkblue;">function</span> <span style="color: blueviolet;">ForEach-Parallel</span> {</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������ ��� <span style="color: darkblue;">param</span>(</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������������� ��� <span style="color: darkgray;">[</span><span style="color: deepskyblue;">Parameter</span>(Mandatory<span style="color: darkgray;">=</span><span style="color: orangered;">$true</span><span style="color: darkgray;">,</span>position<span style="color: darkgray;">=</span><span style="color: purple;">0</span>)<span style="color: darkgray;">]</span> <span style="color: darkgray;">[</span><span style="color: teal;">System.Management.Automation.ScriptBlock</span><span style="color: darkgray;">]</span> <span style="color: orangered;">$ScriptBlock</span><span style="color: darkgray;">,</span></span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������������� ��� <span style="color: darkgray;">[</span><span style="color: deepskyblue;">Parameter</span>(Mandatory<span style="color: darkgray;">=</span><span style="color: orangered;">$true</span><span style="color: darkgray;">,</span>ValueFromPipeline<span style="color: darkgray;">=</span><span style="color: orangered;">$true</span>)<span style="color: darkgray;">]</span> <span style="color: darkgray;">[</span><span style="color: teal;">PSObject</span><span style="color: darkgray;">]</span><span style="color: orangered;">$InputObject</span><span style="color: darkgray;">,</span></span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������������� ��� <span style="color: darkgray;">[</span><span style="color: deepskyblue;">Parameter</span>(Mandatory<span style="color: darkgray;">=</span><span style="color: orangered;">$true</span>)<span style="color: darkgray;">]</span> <span style="color: darkgray;">[</span><span style="color: teal;">int</span><span style="color: darkgray;">]</span><span style="color: orangered;">$MaxThreads</span><span style="color: darkgray;">=</span><span style="color: orangered;">$ThreadCount</span></span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������� )</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������ ��� <span style="color: darkblue;">BEGIN</span> {</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������������� ��� <span style="color: orangered;">$iss</span> <span style="color: darkgray;">=</span> <span style="color: darkgray;">[</span><span style="color: teal;">system.management.automation.runspaces.initialsessionstate</span><span style="color: darkgray;">]::</span>CreateDefault()</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������������� ��� <span style="color: orangered;">$pool</span> <span style="color: darkgray;">=</span> <span style="color: darkgray;">[</span><span style="color: teal;">Runspacefactory</span><span style="color: darkgray;">]::</span>CreateRunspacePool(<span style="color: purple;">1</span><span style="color: darkgray;">,</span> <span style="color: orangered;">$maxthreads</span><span style="color: darkgray;">,</span> <span style="color: orangered;">$iss</span><span style="color: darkgray;">,</span> <span style="color: orangered;">$host</span>)</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������������� ��� <span style="color: orangered;">$pool</span><span style="color: darkgray;">.</span>open()</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������������� ��� <span style="color: orangered;">$threads</span> <span style="color: darkgray;">=</span> @()</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������������� ��� <span style="color: orangered;">$ScriptBlock</span> <span style="color: darkgray;">=</span> <span style="color: orangered;">$ExecutionContext</span><span style="color: darkgray;">.</span>InvokeCommand<span style="color: darkgray;">.</span>NewScriptBlock(<span style="color: darkred;">&quot;param(`$_)`r`n&quot;</span> <span style="color: darkgray;">+</span> <span style="color: orangered;">$Scriptblock</span><span style="color: darkgray;">.</span>ToString())</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������ ��� }</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������ ��� <span style="color: darkblue;">PROCESS</span> {</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������������� ��� <span style="color: orangered;">$powershell</span> <span style="color: darkgray;">=</span> <span style="color: darkgray;">[</span><span style="color: teal;">powershell</span><span style="color: darkgray;">]::</span>Create()<span style="color: darkgray;">.</span>addscript(<span style="color: orangered;">$scriptblock</span>)<span style="color: darkgray;">.</span>addargument(<span style="color: orangered;">$InputObject</span>)</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������������� ��� <span style="color: orangered;">$powershell</span><span style="color: darkgray;">.</span>runspacepool<span style="color: darkgray;">=</span><span style="color: orangered;">$pool</span></span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������������� ��� <span style="color: orangered;">$threads</span><span style="color: darkgray;">+=</span> @{</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������������� ������� instance <span style="color: darkgray;">=</span> <span style="color: orangered;">$powershell</span></span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������������� ������� handle <span style="color: darkgray;">=</span> <span style="color: orangered;">$powershell</span><span style="color: darkgray;">.</span>begininvoke()</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������������� ��� }</span></span><br>�<br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������ ��� }</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������ ��� <span style="color: darkblue;">END</span> {</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������������� ��� <span style="color: orangered;">$notdone</span> <span style="color: darkgray;">=</span> <span style="color: orangered;">$true</span></span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">����������� <span style="color: darkgreen;">#while we have not hit the max thread count, loop and create threads</span></span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������������� ��� <span style="color: darkblue;">while</span> (<span style="color: orangered;">$notdone</span>) {</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������������� ������� <span style="color: orangered;">$notdone</span> <span style="color: darkgray;">=</span> <span style="color: orangered;">$false</span></span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������������� ������� <span style="color: darkblue;">for</span> (<span style="color: orangered;">$i</span><span style="color: darkgray;">=</span><span style="color: purple;">0</span>; <span style="color: orangered;">$i</span> <span style="color: darkgray;">-lt</span> <span style="color: orangered;">$threads</span><span style="color: darkgray;">.</span>count; <span style="color: orangered;">$i</span><span style="color: darkgray;">++</span>) {</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">�������������������� ������� <span style="color: orangered;">$thread</span> <span style="color: darkgray;">=</span> <span style="color: orangered;">$threads</span><span style="color: darkgray;">[</span><span style="color: orangered;">$i</span><span style="color: darkgray;">]</span></span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������������������� <span style="color: darkgreen;">#if a thread is created</span></span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">�������������������� ������� <span style="color: darkblue;">if</span> (<span style="color: orangered;">$thread</span>) {</span></span><br>�<br><span style="font-family: lucida console;"><span style="font-size: 9pt;">����������������������� <span style="color: darkgreen;">#debug, output pool and thread id</span></span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">����������������������� <span style="color: darkgreen;">#write-host &quot;pool instance: &quot;$pool.instanceid &quot;Thread instance:&quot; $Thread.instance.instanceid</span></span></span><br>�<br><span style="font-family: lucida console;"><span style="font-size: 9pt;">����������������������� <span style="color: darkgreen;">#check if thread is complete. if so clean it up</span></span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">�������������������� ����������� <span style="color: darkblue;">if</span> (<span style="color: orangered;">$thread</span><span style="color: darkgray;">.</span>handle<span style="color: darkgray;">.</span>iscompleted) {</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">�������������������������� ����������� <span style="color: orangered;">$thread</span><span style="color: darkgray;">.</span>instance<span style="color: darkgray;">.</span>endinvoke(<span style="color: orangered;">$thread</span><span style="color: darkgray;">.</span>handle)</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">�������������������������� ����������� <span style="color: orangered;">$thread</span><span style="color: darkgray;">.</span>instance<span style="color: darkgray;">.</span>dispose()</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">�������������������������� ����������� <span style="color: orangered;">$threads</span><span style="color: darkgray;">[</span><span style="color: orangered;">$i</span><span style="color: darkgray;">]</span> <span style="color: darkgray;">=</span> <span style="color: orangered;">$null</span></span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">�������������������� ����������� }</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">�������������������� ������� }</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������������� ������� }</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������������� ��� }</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������ ��� }</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">}</span></span><br>�<br><span style="color: darkgreen;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">#MAIN</span></span></span><br>�<br><span style="color: darkgreen;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">#start X number of threads, passing in thread object</span></span></span><br><span style="color: orangered;"><span style="font-family: lucida console;"><span style="font-size: 9pt;">$ThreadObject</span></span></span><span style="font-family: lucida console;"><span style="font-size: 9pt;"> <span style="color: darkgray;">|</span> <span style="color: blue;">ForEach-Parallel</span> <span style="color: navy;">-MaxThreads</span> <span style="color: orangered;">$Threadcount</span> {</span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������ ��� <span style="color: darkgreen;">#PUT CODE FOR EACH THREAD HERE</span></span></span><br>������ ���<br><span style="font-family: lucida console;"><span style="font-size: 9pt;">��������<span style="color: darkgreen;">#start task manager and show the thread and handle count, observe thread count increases proportionate to $threadcount</span></span></span><br>�<br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������� <span style="color: darkgreen;">#Reference scoping settings in $threadobject to set what each thread is supposed to tackle.</span></span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������ ��� <span style="color: darkgreen;">#You can reference the scoping items by $_.[FieldName]</span></span></span><br>�<br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������� <span style="color: darkgreen;">#proof it is running threaded, output is out of order when using write-host. Executing more than just the line below can cause them to come out ordered.</span></span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">����� ��<span style="color: darkgreen;">#write-host &quot;counter:&quot; $_.counter</span></span></span><br>������<br><span style="font-family: lucida console;"><span style="font-size: 9pt;">��������<span style="color: darkgreen;">#This will return all rows from the passing object, one for each thread, since each thread will have been passed one row to it</span></span></span><br><span style="font-family: lucida console;"><span style="font-size: 9pt;">������� <span style="color: darkgreen;">#$ThreadObject</span></span></span><br>�<span style="font-family: lucida console;"><span style="font-size: 9pt;">}</span></span><br>�</p>
<p><strong><span class="wysiwyg-font-size-large">Instructions:</span></strong></p>
<p><strong><span class="wysiwyg-font-size-large">Product:</span></strong> StealthAUDIT<br><strong><span class="wysiwyg-font-size-large">Module:</span></strong> SA - DC - PowerShell<br><strong><span class="wysiwyg-font-size-large">Versions:</span></strong> V6.x, V7.x<br><strong><span class="wysiwyg-font-size-large">Legacy Article ID:</span></strong> 1454</p>
</body>
</html>