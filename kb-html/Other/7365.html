<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Tips &amp; Tricks - Working with Calculated Columns (e.g., CN, NTAccount and NTStyleName)</title>
    <meta name="visibility" content="employees_v">
    <meta name="ArticleCaseAttachCount" content="0">
    <meta name="ArticleCreatedById" content="0054u000006god6AAA">
    <meta name="ArticleCreatedDate" content="2022-02-01T18:44:21.000Z">
    <meta name="Article_Drafts_Folder__c" content="nan">
    <meta name="Article_Reviewer__c" content="nan">
    <meta name="Article_SME__c" content="nan">
    <meta name="Article_Version_Origin__c" content="nan">
    <meta name="Asana_Task_URL__c" content="nan">
    <meta name="AssignedById" content="nan">
    <meta name="AssignedToId" content="nan">
    <meta name="AssignmentDate" content="nan">
    <meta name="AssignmentDueDate" content="nan">
    <meta name="AssignmentNote" content="nan">
    <meta name="Case__c" content="nan">
    <meta name="Confidence_Level__c" content="nan">
    <meta name="CreatedById" content="0054u000006god6AAA">
    <meta name="CreatedDate" content="2023-05-08T10:03:39.000Z">
    <meta name="Draft_Status__c" content="nan">
    <meta name="FirstPublishedDate" content="2022-02-01T18:44:21.000Z">
    <meta name="IsLatestVersion" content="True">
    <meta name="KnowledgeArticleId" content="kA04u0000000I9WCAU">
    <meta name="Knowledge_Article_ID__c" content="kA04u0000000I9WCAU">
    <meta name="LastModifiedById" content="0054u000006gSmgAAE">
    <meta name="LastModifiedDate" content="2023-05-08T10:03:40.000Z">
    <meta name="LastPublishedDate" content="2022-02-01T18:44:21.000Z">
    <meta name="Meta_Description__c" content="360008408371">
    <meta name="Meta_Title__c" content="SQL Tips &amp; Tricks - Working with Calculated Columns (e.g., CN, NTAccount and NTStyleName)">
    <meta name="OwnerId" content="0054u000006god6AAA">
    <meta name="PublishStatus" content="Online">
    <meta name="RecordTypeId" content="0124u000000UUgLAAW">
    <meta name="UrlName" content="7365">
    <meta name="VersionNumber" content="1">
    <meta name="Website_URL__c" content="&lt;a href=&quot;https://helpcenter.netwrix.com/bundle/z-kb-articles-salesforce/page/kA04u0000000I9WCAU.html&quot; target=&quot;_blank&quot;&gt;Open in a new window&lt;/a&gt;">
</head>
<body>
    <h1>SQL Tips &amp; Tricks - Working with Calculated Columns (e.g., CN, NTAccount and NTStyleName)</h1>
    <p><strong><span class="wysiwyg-font-size-large">Summary:</span></strong> Covers performance best practices for joining and filtering on calculated columns in ADInventory and Data Governance Views</p>
<p><strong><span class="wysiwyg-font-size-large">Issue:</span></strong> Something to keep in mind - NTAccount (&#39;Domain\SAMAccountName&#39;) is a calculated value in the Data Governance and ADInventory views, so joining on it is very slow. It&#39;s actually something like this in the background:<br> <br><span style="font-family: courier new;"><span style="font-size: 10pt;">SA_ADInventory_Domains<span style="color: gray;">.</span>Name<span style="color: gray;">+</span><span style="color: red;">&#39;\&#39;</span><span style="color: gray;">+</span>SA_ADInventory_Principals<span style="color: gray;">.</span>SamAccountName</span></span><br> <br>In situations where you need to join or filter based on calculated columns, it&#39;s better to join on IDs if you can, and on the parts that make up the column if you can&#39;t get the IDs easily. If joining a &quot;natural&quot; (non-calculated) column to a calculated column that&#39;s a concatenation of other columns, making a temp table with the pieces of the concatenation is a good first step, and will typically be faster than joining on the calculated column - especially for a large dataset.<br> </p>
<p><strong><span class="wysiwyg-font-size-large">Instructions:</span></strong> Here&#39;s the substring to split up domain and username when given &#39;Domain\SAMAccountName&#39; format:<br> <br><span style="color: blue;"><span style="font-family: courier new;"><span style="font-size: 10pt;">select</span></span></span><br><span style="font-family: courier new;"><span style="font-size: 10pt;">      <span style="color: red;">&#39;DOMAIN\John.Smith&#39;</span></span></span><br><span style="color: gray;"><span style="font-family: courier new;"><span style="font-size: 10pt;">,</span></span></span><span style="font-family: courier new;"><span style="font-size: 10pt;">     <span style="color: fuchsia;">SUBSTRING</span><span style="color: gray;">(</span><span style="color: red;">&#39;DOMAIN\John.Smith&#39;</span><span style="color: gray;">,</span>1<span style="color: gray;">,(</span><span style="color: fuchsia;">CHARINDEX</span><span style="color: gray;">(</span><span style="color: red;">&#39;\&#39;</span><span style="color: gray;">,</span><span style="color: red;">&#39;DOMAIN\John.Smith</span><span style="color: gray;">,</span>1<span style="color: gray;">)-</span>1<span style="color: gray;">))</span> <span style="color: blue;">as</span> SCADomain</span></span><br><span style="color: gray;"><span style="font-family: courier new;"><span style="font-size: 10pt;">,</span></span></span><span style="font-family: courier new;"><span style="font-size: 10pt;">      <span style="color: fuchsia;">SUBSTRING</span><span style="color: gray;">(</span><span style="color: red;">&#39;DOMAIN\John.Smith&#39;</span><span style="color: gray;">,(</span><span style="color: fuchsia;">CHARINDEX</span><span style="color: gray;">(</span><span style="color: red;">&#39;\&#39;</span><span style="color: gray;">,</span><span style="color: red;">&#39;DOMAIN\John.Smith</span><span style="color: gray;">,</span>1<span style="color: gray;">)+</span>1<span style="color: gray;">),</span><span style="color: fuchsia;">LEN</span><span style="color: gray;">(</span><span style="color: red;">&#39;DOMAIN\John.Smith</span><span style="color: gray;">))</span> <span style="color: blue;">as</span> SCASamAccountName</span></span><br> <br> Looking at the execution plan to compare the two versions, joining on the concatenated value was 99% compared to 1% when joining the two columns. In lab tests with a limited dataset, my join on calculated columns took 3 seconds. Joining on two columns was 1% of the batch and the time to insert was negligible. Here&#39;s a scaled down, simplified example you can try in your lab after running ADInventory that shows how the two compare. The exact ratio of performance of the two queries in the batch may vary based on the contents of your database:<br> <br><span style="color: blue;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">select</span></span></span><span style="color: black;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;"> NTAccount </span></span></span><span style="color: blue;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">from</span></span></span><span style="color: black;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;"> SA_ADInventory_PrincipalsView </span></span></span><span style="color: blue;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">where</span></span></span><span style="color: black;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;"> NTAccount</span></span></span><span style="color: gray;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">=</span></span></span><span style="color: red;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">&#39;DOMAIN\User&#39;</span></span></span><br><span style="color: blue;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">select</span></span></span><span style="color: black;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;"> NTAccount </span></span></span><span style="color: blue;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">from</span></span></span><span style="color: black;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;"> SA_ADInventory_PrincipalsView </span></span></span><span style="color: blue;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">where</span></span></span><span style="color: black;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;"> DomainName</span></span></span><span style="color: gray;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">=</span></span></span><span style="color: red;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">&#39;DOMAIN&#39;</span></span></span> <span style="color: gray;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">and</span></span></span><span style="color: black;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;"> SAMAccountName</span></span></span><span style="color: gray;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">=</span></span></span><span style="color: red;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">&#39;User&#39;</span></span></span><br><img src="https://nwxcorp--c.na147.content.force.com/sfc/dist/version/download/?oid=00D7000000091pB&amp;ids=0684u00000Lcaol&amp;d=%2Fa%2F4u000000Lz9E%2F70SltQg.tKyzgfkJAEZqD3KVl9iRKMJ5WxwIj_4SqOE&amp;asPdf=false" alt="50_Instructions_1.jpg"></img><br> <br> <br><span style="color: red;">Moral of the story: <strong>never, ever</strong> join on <u>NTAccount</u> or <u>TrusteeNTStyleName</u> in standard views unless you have absolutely no choice, or the environment is small enough that you don&#39;t have to worry about performance. </span>If you&#39;re working on something custom for a smaller environment, please take the time to join &quot;the right way&quot; so the solution is scalable in other environments (or as the environment grows).<br> <br><strong>Other examples:</strong><br> <br>CN -<br>Similarly, CN is also a calculated value based on the DistinguishedName of the AD object (the &quot;Value&quot; column in the SA_ADInventory_DistinguishedNames table).<br> <br><span style="color: fuchsia;"><span style="font-family: courier new;"><span style="font-size: 10pt;">SUBSTRING</span></span></span><span style="color: gray;"><span style="font-family: courier new;"><span style="font-size: 10pt;">(</span></span></span><span style="font-family: courier new;"><span style="font-size: 10pt;">dn<span style="color: gray;">.</span>Value<span style="color: gray;">,</span> 4<span style="color: gray;">,</span> <span style="color: fuchsia;">PATINDEX</span><span style="color: gray;">(</span><span style="color: red;">&#39;%[^\,],%&#39;</span><span style="color: gray;">,</span>dn<span style="color: gray;">.</span>Value<span style="color: gray;">)</span> <span style="color: gray;">-</span> 3<span style="color: gray;">)</span></span></span><br> <br>Unfortunately, CN is not being collected anywhere else, so there is no substitute for it as far as I know. so grab a coffee if you need to join on CN with a big dataset. Or maybe consider collecting it in the Extended Attributes table and joining back to the other AD data on PrincipalID. That might be faster.<br> <br> <br> </p>
<p><strong><span class="wysiwyg-font-size-large">Product:</span></strong> StealthAUDIT<br><strong><span class="wysiwyg-font-size-large">Module:</span></strong> SA - DC - Active Directory;SA - DC - FSAA - Activity;SA - DC - FSAA - DFS;SA - DC - FSAA - Permissions;SA - DC - SPAA - Activity;SA - DC - SPAA - Permissions<br><strong><span class="wysiwyg-font-size-large">Versions:</span></strong> All<br><strong><span class="wysiwyg-font-size-large">Legacy Article ID:</span></strong> 2222</p>
</body>
</html>