<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>How to find a specific object or objects with specific attributes across multiple databases</title>
    <meta name="visibility" content="employees_v">
    <meta name="ArticleCaseAttachCount" content="0">
    <meta name="ArticleCreatedById" content="0054u000006god6AAA">
    <meta name="ArticleCreatedDate" content="2022-02-01T18:34:18.000Z">
    <meta name="Article_Drafts_Folder__c" content="nan">
    <meta name="Article_Reviewer__c" content="nan">
    <meta name="Article_SME__c" content="nan">
    <meta name="Article_Version_Origin__c" content="nan">
    <meta name="Asana_Task_URL__c" content="nan">
    <meta name="AssignedById" content="nan">
    <meta name="AssignedToId" content="nan">
    <meta name="AssignmentDate" content="nan">
    <meta name="AssignmentDueDate" content="nan">
    <meta name="AssignmentNote" content="nan">
    <meta name="Case__c" content="nan">
    <meta name="Confidence_Level__c" content="nan">
    <meta name="CreatedById" content="0054u000006god6AAA">
    <meta name="CreatedDate" content="2023-05-08T10:11:58.000Z">
    <meta name="Draft_Status__c" content="nan">
    <meta name="FirstPublishedDate" content="2022-02-01T18:34:18.000Z">
    <meta name="IsLatestVersion" content="True">
    <meta name="KnowledgeArticleId" content="kA04u0000000IqNCAU">
    <meta name="Knowledge_Article_ID__c" content="kA04u0000000IqNCAU">
    <meta name="LastModifiedById" content="0054u000006gSmgAAE">
    <meta name="LastModifiedDate" content="2023-05-08T10:11:58.000Z">
    <meta name="LastPublishedDate" content="2022-02-01T18:34:18.000Z">
    <meta name="Meta_Description__c" content="360008408371">
    <meta name="Meta_Title__c" content="How to find a specific object or objects with specific attributes across multiple databases">
    <meta name="OwnerId" content="0054u000006god6AAA">
    <meta name="PublishStatus" content="Online">
    <meta name="RecordTypeId" content="0124u000000UUgLAAW">
    <meta name="UrlName" content="7215">
    <meta name="VersionNumber" content="1">
    <meta name="Website_URL__c" content="&lt;a href=&quot;https://helpcenter.netwrix.com/bundle/z-kb-articles-salesforce/page/kA04u0000000IqNCAU.html&quot; target=&quot;_blank&quot;&gt;Open in a new window&lt;/a&gt;">
</head>
<body>
    <h1>How to find a specific object or objects with specific attributes across multiple databases</h1>
    <p><strong><span class="wysiwyg-font-size-large">Summary:</span></strong> Use of stored procedures as an alternative to cursor creation</p>
<p><strong><span class="wysiwyg-font-size-large">Issue:</span></strong> When trying execute the same command on multiple databases the creation of cursors can make the task longer than needed and using the stored procedure &quot;sp_msforeachdb&quot; can help making the script shorter.</p>
<p><strong><span class="wysiwyg-font-size-large">Instructions:</span></strong>  <br><span style="color: #5b9bd5;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">sp_msforeachdb </span></span></span><span style="color: black;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">is a stored procedure that iterates through all the databases in a SQL instance and executes the same command, which is passed to the stored procedure as a string parameter. This is similar to the exec or sp_execute procedures, but executed as many times as there are databases in the instance</span></span></span><span style="color: #1f497d;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">. </span></span></span><span style="color: black;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">That been said lets analyze the script step by step:</span></span></span><br> </p>
<ul><li style="color: black;margin-left: -4.5pt;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">&#39;?&#39; is a variable that is replaced with the name of the database in the iterator.</span></span></li><li style="color: black;margin-left: -4.5pt;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">The first command in the string parameter is &#39;use&#39;; You need it to establish a session to each database and &#39;?&#39; is a variable that is replaced with the name of the database in the iterator.</span></span></li><li style="color: black;margin-left: -4.5pt;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">The &#39;?&#39; is inside [] to delimit identifiers (object names). This is necessary if the object name is a reserved keyword or contains special characters such as hyphen or space.</span></span></li></ul>
<p> <br><span style="color: black;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">Example 1:</span></span></span><br> <br><span style="color: black;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">This script is checking if a specific table is present in each of the databases that the stored procedure sp_msforeachdb.</span></span></span><br><span style="color: black;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">This command &#39;use [?]...&#39; is run with the purpose of finding out which database has executed a rollback of an action module in a file system by looking for an object ending in &#39;fsactionsrollback&#39;</span></span></span><br><span style="color: black;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">This script is useful because it makes the script shorter and easier to read as opposed to creating a cursor to iterate through each database</span></span></span><br> <br><span style="color: #5b9bd5;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">sp_msforeachdb &#39;use [?]</span></span></span><br><span style="color: #5b9bd5;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">if exists (select null from sys.objects where name like &#39;&#39;%fsactionsrollback&#39;&#39;)</span></span></span><br><span style="color: #5b9bd5;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">select &#39;&#39;?&#39;&#39; as DB, name, type_desc from sys.objects where name like &#39;&#39;%fsactionsrollback&#39;&#39;&#39;</span></span></span><br>  </p>
<ul><li style="color: black;margin-left: -4.5pt;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">The first line of the above script is iterating through each database and opening a session with the database that the variable &#39;?&#39; is holding by use of the keyword &#39;use&#39;</span></span></li><li style="color: black;margin-left: -4.5pt;">
<span style="font-family: consolas;"><span style="font-size: 9.5pt;">The second line is using a conditional that will evaluate the existence of an object ending in </span></span><span style="color: #5b9bd5;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">&#39;fsactionsrollback&#39; </span></span></span><span style="font-family: consolas;"><span style="font-size: 9.5pt;">in the database that is currently in use (which ever database name the variable &#39;?&#39; is holding)</span></span>
</li><li style="color: black;margin-left: -4.5pt;">
<span style="font-family: consolas;"><span style="font-size: 9.5pt;">If the previous condition is true then the select statement in the third line of the script will proceed and columns will be selected from the </span></span><span style="color: #5b9bd5;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">sys.objects </span></span></span><span style="font-family: consolas;"><span style="font-size: 9.5pt;">view.</span></span>
</li><li style="color: black;margin-left: -4.5pt;">
<span style="font-family: consolas;"><span style="font-size: 9.5pt;">This select statement also creates a column named </span></span><span style="color: #5b9bd5;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">&#39;DB&#39; </span></span></span><span style="font-family: consolas;"><span style="font-size: 9.5pt;">to display the name of the current database that </span></span><span style="color: #5b9bd5;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">sp_msforeachdb </span></span></span><span style="font-family: consolas;"><span style="font-size: 9.5pt;">is iterating through. Because the whole point of this script is to tell us if that object exists and in which database.</span></span>
</li><li style="color: #5b9bd5;margin-left: -4.5pt;">
<span style="color: black;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">Please note the use of escape characters on the second line for </span></span></span><span style="font-family: consolas;"><span style="font-size: 9.5pt;">&#39;&#39;%fsactionsrollback&#39;&#39; </span></span><span style="color: black;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">and in the third line </span></span></span><span style="font-family: consolas;"><span style="font-size: 9.5pt;">&#39;&#39;?&#39;&#39;</span></span><span style="color: black;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">.  Without the escape characters the quotation marks would mean the end of the command given to the store procedure to execute.</span></span></span> </li></ul>
<p> <span style="color: black;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">Example 2:</span></span></span><br> <br><span style="color: black;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">This script is searching for any columns that contain a data type &#39;text&#39; in all the databases that sp_msforeachdb is iterating through and displays the results found by database.</span></span></span><br><span style="color: black;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">This command is run with the purpose of identifying in which database the data type text is located to change it for the data type vachar(MAX). This is done because after SQL Server 2005 the text type will not be supported by Microsoft anymore.</span></span></span><br><span style="color: black;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">This script is useful because it makes the script shorter and easier to read as opposed to creating a cursor to iterate through each database.</span></span></span><br> <br><span style="color: #5b9bd5;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">sp_msforeachdb &#39;use [?] </span></span></span><br><span style="color: #5b9bd5;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">if exists (select null from information_schema.columns where data_type=&#39;&#39;text&#39;&#39;)</span></span></span><br><span style="color: #5b9bd5;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">select distinct &#39;&#39;?&#39;&#39; as DB, table_name, column_name from information_schema.columns where data_type=&#39;&#39;text&#39;&#39;&#39;</span></span></span><br><br></p>
<ul><li style="color: black;margin-left: -4.5pt;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">The first line of the above script is iterating through each database and opening a session with the database that the variable &#39;?&#39; is holding by use of the keyword &#39;use&#39;</span></span></li><li style="color: black;margin-left: -4.5pt;">
<span style="font-family: consolas;"><span style="font-size: 9.5pt;">The second line is using a conditional that will evaluate the existence of at least one column that contains the data type &#39;text&#39; in the database that is currently in use (which ever database name the variable &#39;?&#39; is holding) by searching in the </span></span><span style="color: #5b9bd5;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">information_schema.columns </span></span></span><span style="font-family: consolas;"><span style="font-size: 9.5pt;">view.</span></span>
</li><li style="color: black;margin-left: -4.5pt;">
<span style="font-family: consolas;"><span style="font-size: 9.5pt;">If the previous condition is true then the select statement in the third line of the script will proceed and columns will be selected from the </span></span><span style="color: #5b9bd5;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">information_schema.columns view</span></span></span>
</li><li style="color: black;margin-left: -4.5pt;">
<span style="font-family: consolas;"><span style="font-size: 9.5pt;">This select statement also creates a column named </span></span><span style="color: #5b9bd5;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">&#39;DB&#39; </span></span></span><span style="font-family: consolas;"><span style="font-size: 9.5pt;">to display the name of the current database that </span></span><span style="color: #5b9bd5;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">sp_msforeachdb </span></span></span><span style="font-family: consolas;"><span style="font-size: 9.5pt;">is iterating through. Because the whole point of this script is to tell us in which database that column exists.</span></span>
</li><li style="color: #5b9bd5;margin-left: -4.5pt;">
<span style="color: black;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">Please note the use of escape characters on the second line for </span></span></span><span style="font-family: consolas;"><span style="font-size: 9.5pt;">&#39;&#39;text&#39;&#39; </span></span><span style="color: black;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">and in the third line </span></span></span><span style="font-family: consolas;"><span style="font-size: 9.5pt;">&#39;&#39;?&#39;&#39;</span></span><span style="color: black;"><span style="font-family: consolas;"><span style="font-size: 9.5pt;">.  Without the escape characters, the quotation marks would mean the end of the command given to the stored procedure to execute.</span></span></span> </li></ul>
<p>Note:     <strong><em>-There is also a stored procedure for table iteration in case you need it &quot;sp_msforeachtable&quot;</em></strong><br><strong><em>                -These two stored procedures(sp_msforeachdb and sp_msforeachtable) are not supported by Microsoft and should only be used for troubleshooting.  Reason being that it may skip some databases while iterating or even break completely.</em></strong><br><strong><em>                -These stored procedures will only work in MSSQL</em></strong><br> </p>
<p><strong><span class="wysiwyg-font-size-large">Product:</span></strong> StealthAUDIT<br><strong><span class="wysiwyg-font-size-large">Module:</span></strong> File Activity Monitor - Windows;SA - Core;SI - Admin Console<br><strong><span class="wysiwyg-font-size-large">Legacy Article ID:</span></strong> 2159</p>
</body>
</html>