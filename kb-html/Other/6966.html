<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SharePoint Online scans failing to scan despite having proper permissions and credentials, error: 401 Unauthorized / name or password is not valid.</title>
    <meta name="visibility" content="employees_v">
    <meta name="ArticleCaseAttachCount" content="0">
    <meta name="ArticleCreatedById" content="0054u000006god6AAA">
    <meta name="ArticleCreatedDate" content="2022-02-01T18:28:36.000Z">
    <meta name="Article_Drafts_Folder__c" content="nan">
    <meta name="Article_Reviewer__c" content="nan">
    <meta name="Article_SME__c" content="nan">
    <meta name="Article_Version_Origin__c" content="nan">
    <meta name="Asana_Task_URL__c" content="nan">
    <meta name="AssignedById" content="nan">
    <meta name="AssignedToId" content="nan">
    <meta name="AssignmentDate" content="nan">
    <meta name="AssignmentDueDate" content="nan">
    <meta name="AssignmentNote" content="nan">
    <meta name="Case__c" content="nan">
    <meta name="Confidence_Level__c" content="nan">
    <meta name="CreatedById" content="0054u000006god6AAA">
    <meta name="CreatedDate" content="2023-05-08T10:09:49.000Z">
    <meta name="Draft_Status__c" content="nan">
    <meta name="FirstPublishedDate" content="2022-02-01T18:28:37.000Z">
    <meta name="IsLatestVersion" content="True">
    <meta name="KnowledgeArticleId" content="kA04u0000000IfzCAE">
    <meta name="Knowledge_Article_ID__c" content="kA04u0000000IfzCAE">
    <meta name="LastModifiedById" content="0054u000006gSmgAAE">
    <meta name="LastModifiedDate" content="2023-05-08T10:09:50.000Z">
    <meta name="LastPublishedDate" content="2022-02-01T18:28:37.000Z">
    <meta name="Meta_Description__c" content="360008408371">
    <meta name="Meta_Title__c" content="SharePoint Online scans failing to scan despite having proper permissions and credentials, error: 401 Unauthorized / name or password is not valid.">
    <meta name="OwnerId" content="0054u000006god6AAA">
    <meta name="PublishStatus" content="Online">
    <meta name="RecordTypeId" content="0124u000000UUgLAAW">
    <meta name="UrlName" content="6966">
    <meta name="VersionNumber" content="1">
    <meta name="Website_URL__c" content="&lt;a href=&quot;https://helpcenter.netwrix.com/bundle/z-kb-articles-salesforce/page/kA04u0000000IfzCAE.html&quot; target=&quot;_blank&quot;&gt;Open in a new window&lt;/a&gt;">
</head>
<body>
    <h1>SharePoint Online scans failing to scan despite having proper permissions and credentials, error: 401 Unauthorized / name or password is not valid.</h1>
    <p><strong><span class="wysiwyg-font-size-large">Summary:</span></strong> Despite having the proper credentials SharePoint online scans failing to connect with errors related to having &#39;No credentials to favour for the host&quot;.</p><p><strong><span class="wysiwyg-font-size-large">Issue:</span></strong> <strong><span style="font-family: calibri,sans-serif;">Even with having Global administrator privileges, SPO scans were still failing with 401 unauthorized errors:</span></strong><br><strong><span style="font-family: calibri,sans-serif;">&quot;Unable to negotiate http connection via </span></strong><a href="http://company.sharepoint.com/" target="_blank">http://company.sharepoint.com/</a><strong><span style="font-family: calibri,sans-serif;"> due to error: The remote server returned an error: (401) Unauthorized. &quot;</span></strong><br><strong><span style="font-family: calibri,sans-serif;">&quot;Unable to negotiate admin connection via </span></strong><a href="https://company.sharepoint.com" target="_blank">https://company.sharepoint.com</a><strong><span style="font-family: calibri,sans-serif;"> due to error: The user&#39;s login name or password is not valid. &quot;</span></strong><br><img alt="User-added image" src="https://nwxcorp--c.na147.content.force.com/sfc/dist/version/download/?oid=00D7000000091pB&amp;ids=0684u00000LcaSG&amp;d=%2Fa%2F4u000000LyqM%2FGawWYTq_HjrJMzVCzL6cGUneJvv_xKPU1P.smEwDukQ&amp;asPdf=false"></img><br> <br><strong><span style="font-family: calibri,sans-serif;">The first step in diagnosing this issue is to try and connect to the admin tenant using PowerShell. This will require the SharePoint Online Management Shell with the powershell commandlets available. Simply running the Connect-SPOService command (with SA service account) should show a similar error to that received in StealthAUDIT </span></strong><br><img alt="User-added image" src="https://nwxcorp--c.na147.content.force.com/sfc/dist/version/download/?oid=00D7000000091pB&amp;ids=0684u00000Lca72&amp;d=%2Fa%2F4u000000Lyf0%2FfqbC7rDUcGm4ykhQCvuuFhxBkjsv6GtRVyu2QwvDkFQ&amp;asPdf=false" width="500" height="220"></img><br><strong><span style="font-family: calibri,sans-serif;">This is most likely due to the fact that the LegacyAuthProtocalsEnabled parameter is set to false, which prohibits connection from third parties to SharePoint Online.</span></strong><br><span style="color: black;"><span style="font-family: calibri light,sans-serif;"><span style="font-size: 11pt;">A value of <strong><span style="font-family: calibri light,sans-serif;">True</span></strong></span>- Enables Office clients using non-modern authentication protocols (such as, Forms-Based Authentication (FBA) or Identity Client Runtime Library (IDCRL)) to access SharePoint resources.</span></span><br><span style="color: black;"><span style="font-family: calibri light,sans-serif;"><span style="font-size: 11pt;">A value of <strong><span style="font-family: calibri light,sans-serif;">False</span></strong></span>-Prevents Office clients using non-modern authentication protocols from accessing SharePoint Online resources. Additionally, a value of <b>False </b>prevents 3<sup>rd</sup> party applications (including CSOM queries that StealthAUDIT leverages) from authenticating to SharePoint Online.</span></span><br> </p><p><strong><span class="wysiwyg-font-size-large">Instructions:</span></strong> <strong><span style="font-family: calibri,sans-serif;">Once you&#39;ve run the PowerShell script and produced the aforementioned error, restart powerShell and leverage credentials with Global Admin privileges to update the LegacyAuthProtocolsEnabled parameter to True. </span></strong><br><span><span style="color: #404040;"><span style="font-family: arial,sans-serif;">The customer may not have the SharePoint Online module installed for powershell, this can be achieved by running the following command: </span></span></span></p><pre> <span style="color: #404040;"><span style="font-family: courier;"><span style="font-size: 12pt;">Install-Module -Name Microsoft.Online.SharePoint.PowerShell</span></span></span></pre><span><span style="color: #404040;"><span style="font-family: arial,sans-serif;">Once you have the SPO module installed run the following command to attempt connection to SharePoint Online</span></span></span> <pre> <span style="color: #404040;"><span style="font-family: courier;"><span style="font-size: 12pt;">Connect-SPOService</span></span></span></pre><span><span style="color: #404040;"><span style="font-family: arial,sans-serif;">You will be prompted to enter the URL to connect to, this needs to be the -admin url which is what StealthAUDIT connects to. It should look something like </span></span></span><span><span style="font-family: arial,sans-serif;"><a href="https://CompanyName-admin.SharePoint.com" target="_blank">https://CompanyName-admin.SharePoint.com</a></span></span><span><span style="color: #404040;"><span style="font-family: arial,sans-serif;">.</span></span></span><br><span><span style="color: #404040;"><span style="font-family: arial,sans-serif;">To check for the current value of the LegacyAuthProtocolsEnabled parameter, run: </span></span></span><pre> <span style="color: #404040;"><span style="font-family: courier;"><span style="font-size: 12pt;">Get-SPOTenant </span></span></span></pre><span><span style="color: #404040;"><span style="font-family: arial,sans-serif;">If this is set to false, you must set it to true by running the following commands</span></span></span> <pre> <span style="color: #404040;"><span style="font-family: courier;"><span style="font-size: 12pt;">Set-SPOTenant -LegacyAuthProtocolsEnabled $True</span></span></span></pre>After you run these commands check that the changes were made by typing: Get-SPOTenant and look for LegacyAuthProtocolsEnable : True<br>These are the settings you want to see after running SPOTenant:<br><img alt="User-added image" src="" width="500" height="64"></img><br><b>Note: <u>When we used this troubleshooting method with a customer the changes took 24 hours to be respected. Online articles suggest it can take up to 48 hours for the changes to be respected in some cases.</u></b><br> <p><strong><span class="wysiwyg-font-size-large">Product:</span></strong> StealthAUDIT<br><strong><span class="wysiwyg-font-size-large">Module:</span></strong> SA - Solution Set - SharePoint<br><strong><span class="wysiwyg-font-size-large">Versions:</span></strong> 8.0+<br><strong><span class="wysiwyg-font-size-large">Salesforce Article ID:</span></strong> 2106<br></p>
</body>
</html>