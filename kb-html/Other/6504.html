<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repair Non dbo Schema</title>
    <meta name="visibility" content="employees_v">
    <meta name="ArticleCaseAttachCount" content="0">
    <meta name="ArticleCreatedById" content="0054u000006god6AAA">
    <meta name="ArticleCreatedDate" content="2022-02-01T18:18:32.000Z">
    <meta name="Article_Drafts_Folder__c" content="nan">
    <meta name="Article_Reviewer__c" content="nan">
    <meta name="Article_SME__c" content="nan">
    <meta name="Article_Version_Origin__c" content="nan">
    <meta name="Asana_Task_URL__c" content="nan">
    <meta name="AssignedById" content="nan">
    <meta name="AssignedToId" content="nan">
    <meta name="AssignmentDate" content="nan">
    <meta name="AssignmentDueDate" content="nan">
    <meta name="AssignmentNote" content="nan">
    <meta name="Case__c" content="nan">
    <meta name="Confidence_Level__c" content="nan">
    <meta name="CreatedById" content="0054u000006god6AAA">
    <meta name="CreatedDate" content="2023-05-08T10:06:17.000Z">
    <meta name="Draft_Status__c" content="nan">
    <meta name="FirstPublishedDate" content="2022-02-01T18:18:32.000Z">
    <meta name="IsLatestVersion" content="True">
    <meta name="KnowledgeArticleId" content="kA04u0000000IO4CAM">
    <meta name="Knowledge_Article_ID__c" content="kA04u0000000IO4CAM">
    <meta name="LastModifiedById" content="0054u000006gSmgAAE">
    <meta name="LastModifiedDate" content="2023-05-08T10:06:17.000Z">
    <meta name="LastPublishedDate" content="2022-02-01T18:18:32.000Z">
    <meta name="Meta_Description__c" content="360008408371">
    <meta name="Meta_Title__c" content="Repair Non dbo Schema">
    <meta name="OwnerId" content="0054u000006god6AAA">
    <meta name="PublishStatus" content="Online">
    <meta name="RecordTypeId" content="0124u000000UUgLAAW">
    <meta name="UrlName" content="6504">
    <meta name="VersionNumber" content="1">
    <meta name="Website_URL__c" content="&lt;a href=&quot;https://helpcenter.netwrix.com/bundle/z-kb-articles-salesforce/page/kA04u0000000IO4CAM.html&quot; target=&quot;_blank&quot;&gt;Open in a new window&lt;/a&gt;">
</head>
<body>
    <h1>Repair Non dbo Schema</h1>
    <p><strong><span class="wysiwyg-font-size-large">Summary:</span></strong> how to repair non dbo schema</p>
<p><strong><span class="wysiwyg-font-size-large">Issue:</span></strong> If a user doesn&#39;t have a default schema of dbo, SQL (2008+?) will automatically use a schema based on the username.<br><br>so, where a table in StealthAUDIT should be <br>dbo.SA_MyJob_Table <br><br>it gets created as <br>MyUserName.SA_MyJob_Table <br><br>Therefore, each user will have a separate set of tables and it can get confusing as to what the problem is pretty quickly.</p>
<p>Newer Versions of StealthAUDIT will prevent you from opening the console if you have the incorrect schema.</p>
<p>You can use the following script to move the tables from one schema to another. <br><br>If the table exists in the dbo schema already, too, you&#39;ll have to decide to either drop one or combine them by renaming one, moving schema, then running an insert, if applicable.</p>
<p><strong><span class="wysiwyg-font-size-large">Instructions:</span></strong> DECLARE cursore CURSOR FOR <br><br>select specific_schema as &#39;schema&#39;, specific_name AS &#39;name&#39;<br>FROM INFORMATION_SCHEMA.routines r1<br>WHERE specific_schema AND NOT EXISTS( --no equivalent object exists with dbo schema<br>    SELECT NULL<br>    FROM INFORMATION_SCHEMA.Routines r2<br>    WHERE r1.SPECIFIC_NAME = r2.SPECIFIC_NAME AND r2.SPECIFIC_SCHEMA = &#39;dbo&#39;)<br>    <br>UNION ALL<br><br>SELECT TABLE_SCHEMA AS &#39;schema&#39;, TABLE_NAME AS &#39;name&#39;<br>FROM INFORMATION_SCHEMA.TABLES t1<br>WHERE TABLE_SCHEMA AND NOT EXISTS( --no equivalent object exists with dbo schema<br>    SELECT NULL<br>    FROM INFORMATION_SCHEMA.TABLES t2<br>    WHERE t1.TABLE_NAME = t2.TABLE_NAME AND t2.TABLE_SCHEMA = &#39;dbo&#39;)<br><br>DECLARE @schema sysname, <br> @tab sysname, <br> @sql varchar(500) <br><br>OPEN cursore     <br>FETCH NEXT FROM cursore INTO @schema, @tab <br><br>WHILE @@FETCH_STATUS = 0     <br>BEGIN <br> SET @sql = &#39;ALTER SCHEMA dbo TRANSFER [&#39; + @schema + &#39;].[&#39; + @tab +&#39;]&#39;    <br> PRINT @sql   <br> exec (@sql)  <br> FETCH NEXT FROM cursore INTO @schema, @tab     <br>END <br><br>CLOSE cursore     <br>DEALLOCATE cursore<br><br><span style="color: #ff0000;">--FROM HERE DOWN WILL DROP ALL TABLES, VIEWS, FUNCTIONS, PROCEDURES THAT ARE NOT DBO SCHEMA<br>--So, if you intend on moving some, make sure the above script did what you want before running the rest </span><br><br>GO<br><br>-- drop tables ---<br><br>DECLARE cursore CURSOR FOR <br><br>SELECT TABLE_SCHEMA AS &#39;schema&#39;, TABLE_NAME AS &#39;name&#39;<br>FROM INFORMATION_SCHEMA.TABLES t1<br>WHERE TABLE_SCHEMA AND TABLE_TYPE=&#39;BASE TABLE&#39;<br>AND EXISTS( --no equivalent object exists with dbo schema<br>    SELECT NULL<br>    FROM INFORMATION_SCHEMA.TABLES t2<br>    WHERE t1.TABLE_NAME = t2.TABLE_NAME AND t2.TABLE_SCHEMA = &#39;dbo&#39; AND t2.TABLE_TYPE = &#39;BASE TABLE&#39;)<br><br>DECLARE @schema sysname, <br> @tab sysname, <br> @sql varchar(500) <br><br>OPEN cursore     <br>FETCH NEXT FROM cursore INTO @schema, @tab <br><br>WHILE @@FETCH_STATUS = 0     <br>BEGIN <br> SET @sql = &#39;drop table [&#39;+ @schema + &#39;].[&#39; + @tab +&#39;]&#39;<br> PRINT @sql   <br> exec (@sql)  <br> FETCH NEXT FROM cursore INTO @schema, @tab     <br>END <br><br>CLOSE cursore     <br>DEALLOCATE cursore<br><br>GO<br><br>-- drop views ---<br><br>DECLARE cursore CURSOR FOR <br><br>SELECT TABLE_SCHEMA AS &#39;schema&#39;, TABLE_NAME AS &#39;name&#39;<br>FROM INFORMATION_SCHEMA.TABLES t1<br>WHERE TABLE_SCHEMA AND TABLE_TYPE=&#39;VIEW&#39;<br>AND EXISTS( --no equivalent object exists with dbo schema<br>    SELECT NULL<br>    FROM INFORMATION_SCHEMA.TABLES t2<br>    WHERE t1.TABLE_NAME = t2.TABLE_NAME AND t2.TABLE_SCHEMA = &#39;dbo&#39; AND t2.TABLE_TYPE = &#39;VIEW&#39;)<br><br>DECLARE @schema sysname, <br> @tab sysname, <br> @sql varchar(500) <br><br>OPEN cursore     <br>FETCH NEXT FROM cursore INTO @schema, @tab <br><br>WHILE @@FETCH_STATUS = 0     <br>BEGIN <br> SET @sql = &#39;drop view [&#39;+ @schema + &#39;].[&#39; + @tab +&#39;]&#39;<br> PRINT @sql   <br> exec (@sql)  <br> FETCH NEXT FROM cursore INTO @schema, @tab     <br>END <br><br>CLOSE cursore     <br>DEALLOCATE cursore<br><br>GO<br><br>--drop functions-----------------------<br><br>DECLARE cursore CURSOR FOR <br><br>select specific_schema as &#39;schema&#39;, specific_name AS &#39;name&#39;<br>FROM INFORMATION_SCHEMA.routines r1<br>WHERE specific_schema AND EXISTS( --no equivalent object exists with dbo schema<br>    SELECT NULL<br>    FROM INFORMATION_SCHEMA.Routines r2<br>    WHERE r1.SPECIFIC_NAME = r2.SPECIFIC_NAME AND r2.SPECIFIC_SCHEMA = &#39;dbo&#39; AND r2.ROUTINE_TYPE = &#39;FUNCTION&#39;)<br>AND r1.ROUTINE_TYPE = &#39;FUNCTION&#39;<br><br>DECLARE @schema sysname, <br> @tab sysname, <br> @sql varchar(500) <br><br>OPEN cursore     <br>FETCH NEXT FROM cursore INTO @schema, @tab <br><br>WHILE @@FETCH_STATUS = 0     <br>BEGIN <br> SET @sql = &#39;drop function [&#39;+ @schema + &#39;].[&#39; + @tab +&#39;]&#39;<br> PRINT @sql   <br> exec (@sql)  <br> FETCH NEXT FROM cursore INTO @schema, @tab     <br>END <br><br>CLOSE cursore     <br>DEALLOCATE cursore<br><br>GO</p>
<p>--drop procedures-----------------------<br><br>DECLARE cursore CURSOR FOR <br><br>select specific_schema as &#39;schema&#39;, specific_name AS &#39;name&#39;<br>FROM INFORMATION_SCHEMA.routines r1<br>WHERE specific_schema AND r1.ROUTINE_TYPE = &#39;PROCEDURE&#39;<br>AND EXISTS( --no equivalent object exists with dbo schema<br>    SELECT NULL<br>    FROM INFORMATION_SCHEMA.Routines r2<br>    WHERE r1.SPECIFIC_NAME = r2.SPECIFIC_NAME AND r2.SPECIFIC_SCHEMA = &#39;dbo&#39; AND r2.ROUTINE_TYPE = &#39;PROCEDURE&#39;)<br><br>DECLARE @schema sysname, <br> @tab sysname, <br> @sql varchar(500) <br><br>OPEN cursore     <br>FETCH NEXT FROM cursore INTO @schema, @tab <br><br>WHILE @@FETCH_STATUS = 0     <br>BEGIN <br> SET @sql = &#39;drop procedure [&#39;+ @schema + &#39;].[&#39; + @tab +&#39;]&#39;<br> PRINT @sql   <br> exec (@sql)  <br> FETCH NEXT FROM cursore INTO @schema, @tab     <br>END <br><br>CLOSE cursore     <br>DEALLOCATE cursore<br><br>/*<br><br>create table guest.SA_Tbl (blah varchar(50))<br>go<br>create view guest.SA_View as (select * from guest.SA_Tbl)<br><br>*/</p>
<p><strong><span class="wysiwyg-font-size-large">Module:</span></strong> Database/SQL<br><strong><span class="wysiwyg-font-size-large">Dev Ticket:</span></strong> 6930<br><strong><span class="wysiwyg-font-size-large">Salesforce Article ID:</span></strong> 000001173</p>
</body>
</html>