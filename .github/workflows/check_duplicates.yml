name: Check for Duplicate Articles

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'knowledge_base/**'
      - '.github/workflows/check_duplicates.yml'
      - '.github/workflows/detect_duplicates.py'

jobs:
  check-duplicates:
    name: Check for duplicate articles
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Fetch all history for the repository

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install beautifulsoup4 scikit-learn pandas requests
        
    - name: Run duplicate detection
      id: duplicates
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_HEAD_REF: ${{ github.head_ref || '' }}
        GITHUB_BASE_REF: ${{ github.base_ref || '' }}
      run: |
        # Install required Python packages
        python -m pip install beautifulsoup4 scikit-learn pandas requests
        
        # Run the duplicate detection script
        python .github/workflows/detect_duplicates.py \
          --threshold 0.6 \
          --output-format both \
          --github-token ${{ secrets.GITHUB_TOKEN }} \
          --github-event-path ${{ github.event_path }}
        
        # The script will handle PR comments and output the results
